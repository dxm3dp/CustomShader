# 空间变换

2020.3.29(7) 3.31(2)

在渲染流水线中 , 我们往往需要把一个点或方向矢量从一个坐标空间转换到另一个坐标空间 . 这个过程到底是怎么实现的呢 ?

我们知道 , 要想定义一个坐标空间 , 必须指明其原点位置和 3 个坐标轴的方向 . 而这些数值实际上是相对于另一个坐标空间的 ( 所有的都是相对的 ) . 也就是说 , 坐标空间会形成一个层次结构 -- 每个坐标空间都是另一个坐标空间的子空间 , 反过来说 , 每个空间都有一个父坐标空间 . **对坐标空间的变换实际上就是在父空间和子空间之间对点和矢量进行变换** .

假设 , 现在有父坐标空间 P 以及一个子坐标空间 C . 我们知道在父坐标空间中子坐标空间的原点位置以及 3 个单位坐标轴 . 我们一般会有两种需求 : 一种需求是把子坐标空间下表示的点或矢量 $A_c$ 转换到父坐标空间下的表示 $A_p$ ; 另一个需求是反过来 , 把父坐标空间下表示的点或矢量 $B_p$ 转换到子坐标空间下的表示 $B_c$ . 我们可以使用下面的公式来表示这两种需求 :

$$
A_p = M_{c\rightarrow p} A_c
$$

$$
B_c = M_{p\rightarrow c} B_p
$$

其中 , $M_{c\rightarrow p}$ 表示的是从子坐标空间变换到父坐标空间的变换矩阵 , 而 $M_{p\rightarrow c}$ 是其逆矩阵 ( 即反向变换 ) . 那么 , 现在的问题就是 , 如何求解这些变换矩阵 ? 事实上 , 我们只需要解出两者之一即可 , 另一个矩阵可以通过求逆矩阵的方式来得到 .

## 求解 $M_{c \rightarrow p}$

下面 , 我们就来讲解如何求出从**子坐标空间**到**父坐标空间**的变换矩阵 $M_{c\rightarrow p}$ .

首先 , 我们来回顾一个看似很简单的问题 : 当给定一个坐标空间以及其中一点 ( a , b , c ) 时 , 我们是如何知道该点的位置的呢 ?

实际上 , 我们可以通过 4 个步骤来确定它的位置 :

1. 从坐标空间的原点开始 ;
2. 向 x 轴方向移动 a 个单位 ;
3. 向 y 轴方向移动 b 个单位 ;
4. 向 z 轴方向移动 c 个单位 .

需要说明的是 , 上面的步骤只是我们的想象 , 这个点并没有发生移动 . 上面的步骤看起来再简单不过了 , 坐标空间的变换就蕴含在上面的 4 个步骤中 .

现在 , 我们已知子坐标空间 $C$ 的 3 个坐标轴在父坐标空间 $P$ 下的表示 $x_c$ , $y_c$ , $z_c$ , 以及其原点位置 $O_c$ . 当给定一个子坐标空间中的一点 $A_c = (a, b, c)$ , 我们同样可以依照上面 4 个步骤来确定其在父坐标空间下的位置 $A_p$ .

**1. 从子坐标空间的原点开始** . 这很简单 , 我们已经知道了子坐标空间的原点位置 $O_c$ .

**2. 向 x 轴方向移动 a 个单位** . 仍然很简单 , 因为我们已经知道了 x 轴的矢量表示 , 因此可以得到 :

$$
O_c + ax_c
$$

**3. 向 y 轴方向移动 b 个单位** . 同样的道理 , 这一步就是 :

$$
O_c + ax_c + by_c
$$

**4. 向 z 轴方向移动 c 个单位** . 最后 , 就可以得到 :

$$
O_c + ax_c + by_c + cz_c
$$

现在 , 我们已经求出了 $M_{c\rightarrow p}$ ! 我们再来看一下最后得到的式子 :

$$
A_p = O_c + ax_c + by_c + cz_c
$$

你可能会问 , 这个式子里根本没有矩阵呀 ! 真的是这样吗 ?

$$
\begin{aligned}
A_p &= O_c + ax_c + by_c + cz_c \\
    &= (x_{o_c} , y_{o_c} , z_{o_c}) + a(x_{x_c} , y_{x_c} , z_{x_c}) + b(x_{y_c} , y_{y_c} , z_{y_c}) + c(x_{z_c} , y_{z_c} , z_{z_c}) \\
    &= (x_{o_c} , y_{o_c} , z_{o_c}) +
    \left[ \begin{matrix}
        x_{x_c} & x_{y_c} & x_{z_c} \\
        y_{x_c} & y_{y_c} & y_{z_c} \\
        z_{x_c} & z_{y_c} & z_{z_c}
        \end{matrix}
    \right]
    \left[ \begin{matrix}
        a \\
        b \\
        c
    \end{matrix}
    \right] \\
    &= (x_{o_c} , y_{o_c} , z_{o_c}) +
    \left[ \begin{matrix}
        | & | & | \\
        x_c & y_c & z_c \\
        | & | & |
        \end{matrix}
    \right]
    \left[ \begin{matrix}
        a \\
        b \\
        c
    \end{matrix}
    \right]
\end{aligned}
$$

其中 "|" 符号表示是按列展开的 . 这个最后的表达式还不是很漂亮 , 因为还存在加法表达式 , 即平移变换 . 我们已经知道 , $3 \times 3$ 的矩阵无法表示平移变换 , 因此为了得到一个更漂亮的结果 , 我们把上面的式子扩展到齐次坐标空间中 , 得

$$
\begin{aligned}
A_p &= (x_{o_c} , y_{o_c} , z_{o_c} , 1) +
    \left[
        \begin{matrix}
        | & | & | & 0 \\
        x_c & y_c & z_c & 0 \\
        | & | & | & 0 \\
        0 & 0 & 0 & 1
        \end{matrix}
    \right]
    \left[
        \begin{matrix}
        a \\
        b \\
        c \\
        1
        \end{matrix}
    \right] \\
    &=
    \left[
        \begin{matrix}
        1 & 0 & 0 & x_{o_c} \\
        0 & 1 & 0 & y_{o_c} \\
        0 & 0 & 1 & z_{o_c} \\
        0 & 0 & 0 & 1
        \end{matrix}
    \right]
    \left[
        \begin{matrix}
        | & | & | & 0 \\
        x_c & y_c & z_c & 0 \\
        | & | & | & 0 \\
        0 & 0 & 0 & 1
        \end{matrix}
    \right]
    \left[
        \begin{matrix}
        a \\
        b \\
        c \\
        1
        \end{matrix}
    \right] \\
    &=
    \left[
        \begin{matrix}
        | & | & | & x_{o_c} \\
        x_c & y_c & z_c & y_{o_c} \\
        | & | & | & z_{o_c} \\
        0 & 0 & 0 & 1
        \end{matrix}
    \right]
    \left[
        \begin{matrix}
        a \\
        b \\
        c \\
        1
        \end{matrix}
    \right] \\
    &=
    \left[
        \begin{matrix}
        | & | & | & | \\
        x_c & y_c & z_c & o_c \\
        | & | & | & | \\
        0 & 0 & 0 & 1
        \end{matrix}
    \right]
    \left[
        \begin{matrix}
        a \\
        b \\
        c \\
        1
        \end{matrix}
    \right] \\

\end{aligned}
$$

现在 , 发现 $M_{c \rightarrow p}$ 在哪里了吧 . 没错 ,

$$
M_{c \rightarrow p} =
\left[
    \begin{matrix}
    | & | & | & | \\
    x_c & y_c & z_c & o_c \\
    | & | & | & | \\
    0 & 0 & 0 & 1
    \end{matrix}
\right]
$$

一旦求出 $M_{c \rightarrow p}$ , $M_{p \rightarrow c}$ 就可以通过求逆矩阵的方式求出来 , 因为从坐标空间 $C$ 变换到坐标空间 $P$ 与从坐标空间 $P$ 变换到坐标空间 $C$ 是互逆的两个过程 .

通过观察矩阵 $M_{c \rightarrow p}$ 我们可以看出 , 变换矩阵 $M_{c \rightarrow p}$ 实际上可以通过坐标空间 $C$ 在坐标空间 $P$ 中的原点和坐标轴的矢量表示来构建出来 : **把 3 个坐标轴依次放入矩阵的前 3 列 , 把原点矢量放到最后一列 , 再用 0 和 1 填充最后一行即可** .

需要注意的是 , 这里我们并没有要求 3 个坐标轴 $x_c$ , $y_c$ , $z_c$ 是单位矢量 , 事实上 , 如果存在缩放的话 , 这 3 个矢量值很可能不是单位矢量 .

更加令人振奋的是 , 我们可以利用反向思维 , 从这个变换矩阵反推来获取子坐标空间的原点和坐标轴方向 . 例如 , 当我们已知从模型空间到世界空间的一个 $4 \times 4$ 的变换矩阵 , 可以提取它的第一列再进行归一化后来得到模型空间的 $x$ 轴在世界空间下的单位矢量表示 . 同样的方法可以提取 $y$ 轴和 $z$ 轴 . 我们可以从另一个角度来理解这个提取的过程 . 因为矩阵 $M_{c \rightarrow p}$ 可以把一个方向矢量从坐标空间 $C$ 变换到坐标空间 $P$ 中 , 那么 , 我们只需要用它来变换坐标空间 $C$ 中的 $x$ 轴 (1 , 0 , 0 , 0) , 即使用矩阵乘法 $M_{c \rightarrow p}
\left[\begin{matrix} 1 & 0 & 0 & 0 \end{matrix}\right] ^ T$ , 得到的结果正是 $M_{c \rightarrow p}$ 的第一列 .

另一个有趣的情况是 , 对方向矢量的坐标空间变换 . 我们知道 , 矢量是没有位置的 , 因此坐标空间的原点变换是可以忽略的 . 也就是说 , 我们仅仅平移坐标系的原点是不会对矢量造成任何影响的 . 那么 , 对矢量的坐标空间变换就可以使用 $3 \times 3$ 的矩阵来表示 , 因为我们不需要表示平移变换 . 那么变换矩阵就是 :

$$
M_{c \rightarrow p} =
\left[
    \begin{matrix}
       | & | & | \\
       x_c & y_c & z_c \\
       | & | & |
    \end{matrix}
\right]
$$

在 Shader 中 , 我们常常会看到截取变换矩阵的前 3 行前 3 列来对法线方向 , 光照方向进行空间变换 , 这正式原因所在 .

现在 , 我们再来关注 $M_{p \rightarrow c}$ . 我们前面讲到 , 可以通过求 $M_{c \rightarrow p}$ 的逆矩阵的方式求解出来反向变换矩阵 $M_{p \rightarrow c}$ . 但有一种情况我们不需要求解逆矩阵就可以得到 $M_{p \rightarrow c}$ . 这种情况就是 $M_{c \rightarrow p}$ 是一个正交矩阵 . 如果它是一个正交矩阵的话 , $M_{c \rightarrow p}$ 的逆矩阵就等于它的转置矩阵 . 这意味着我们不需要进行复杂的求逆操作就可以得到反向变换 .
