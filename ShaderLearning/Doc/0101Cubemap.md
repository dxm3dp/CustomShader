# 立方体纹理

在图形学中 , 立方体纹理是环境映射的一种实现方法 . 环境映射可以模拟物体周围的环境 , 而使用了环境映射的物体可以看起来像镀了层金属一样 , 反射出周围的环境 .

立方体纹理一共包含了 6 张图像 , 这些图像对应了一个立方体的 6 个面 , 立方体纹理的名称也由此而来 . 立方体的每个面表示沿着世界空间下的轴向 ( 上 , 下 , 左 , 右 , 前 , 后 ) 观察所得的图像 . 那么 , 我们如何对这样一种纹理进行采样呢 ? 和之前使用二维纹理坐标不同 , 对立方体纹理进行采样我们需要提供一个三维的纹理坐标 , 这个三维纹理坐标表示了我们在世界空间下的一个 3D 方向 . 这个方向矢量从立方体的中心出发 , 当它向外部延伸时就会和立方体的 6 个纹理之一发生相交 , 而采样得到的结果就是由该交点计算而来的 . 

使用立方体纹理的好处在于 , 它的实现简单快速 , 而且得到的效果也比较好 . 但它也有一些缺点 , 例如当场景中引入了新的物体 , 光源 , 或者物体发生移动时 , 我们就需要重新生成立方体纹理 . 除此之外 , 立方体纹理也仅可以反射环境 , 但不能反射使用了该立方体纹理的物体本身 . 这是因为立方体纹理不能模拟多次反射的结果 , 例如两个金属球互相反射的情况 . 由于这样的原因 , 想要得到令人信服的渲染结果 , 我们应该尽量对凸面体而不要对凹面体使用立方体纹理 ( 因为凹面体会反射自身 ) .

立方体纹理在实时渲染中有很多应用 , 最常见的是用于天空盒子 ( skybox ) 以及环境映射 .

## 创建用于环境映射的立方体纹理

除了天空盒子 , 立方体纹理最常见的用处是用于环境映射 . 在 Unity 5 中 , 创建用于环境映射的立方体纹理的方法有三种 : 第一种方法是直接由一些特殊布局的纹理创建 ; 第二种方法是手动创建一个 Cubemap 资源 , 再把 6 张图赋给它 ; 第三种方法是由脚本生成 .

如果使用第一种方法 , 我们需要提供一张具有特殊布局的纹理 , 例如类似立方体展开图的交叉布局 , 全景布局等 . 然后 , 我们只需要把该纹理的 Texture Type 设置为 Cubemap 即可 , Unity 会为我们做好剩下的事情 . 在基于物理的渲染中 , 我们通常会使用一张 HDR 图像来生成高质量的 Cubemap . 

第二种方法是 Unity 5 之前的版本中使用的方法 . 在 Unity 5 中 , 官方推荐使用第一种方法创建立方体纹理 , 这是因为第一种方法可以对纹理数据进行压缩 , 而且可以支持边缘修正 , 光滑反射 ( glossy reflection ) 和 HDR 等功能 .

前面两种方法都需要我们提前准备好立方体纹理的图像 , 它们得到的立方体纹理往往是被场景中的物体所共用的 . 但在理想情况下 , 我们希望根据物体在场景中位置的不同 , 生成它们各自不同的立方体纹理 . 这时 , 我们就可以在 Unity 中使用脚本来创建 . 这是通过 Unity 提供的 Camera.RenderToCubemap 函数来实现的 . Camera.RenderToCubemap 函数可以把从任意位置观察到的场景图象存储到 6 张图像中 , 从而创建出该位置上对应的立方体纹理 .