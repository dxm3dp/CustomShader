# 为什么渲染顺序很重要

2020.4.16(4)

前面说到 , 对于透明度混合技术 , 需要关闭深度写入 , 此时我们就需要小心处理透明物体的渲染顺序 . 那么 , 我们为什么要关闭深度写入呢 ?

如果不关闭深度写入 , 一个半透明表面背后的表面本来是可以透过它被我们看到的 , 但由于深度测试时判断结果是该半透明表面距离摄像机更近 , 导致后面的表面将会被剔除 , 我们也就无法透过半透明表面看到后面的物体了 . 但是 , 当我们关闭了深度写入 , 也就此破坏了深度缓冲的工作机制 , 而这是一个非常糟糕的事情 , 尽管我们不得不这样做 . **关闭深度写入导致渲染顺序变得非常重要** .

我们来考虑最简单的情况 . 假设场景里有两个物体 A 和 B . 其中 A 是半透明物体 , 而 B 是不透明物体 . 我们来考虑不同的渲染顺序会有什么结果 .

- 第一种情况 , 我们先渲染 B , 再渲染 A , 那么由于不透明物体开启了深度测试和深度写入 , 而此时深度缓冲区中没有任何数据 , 因此 B 首先会写入**颜色缓冲区**和**深度缓冲区** . 随后我们渲染 A , 透明物体仍然进行深度测试 , 因此我们发现和 B 相比 A 距离摄像机更近 , 因此 , 我们会使用 A 的透明度来和颜色缓冲中的 B 的颜色进行混合 , 得到正确的半透明效果 .
- 第二种情况 , 我们先渲染 A , 再渲染 B . 渲染 A 时 , 深度缓冲区中没有任何数据 , 因此 A 直接写入颜色缓冲区 . 但由于对半透明物体关闭了深度写入 , 因此 A 不会修改深度缓冲区 . 等到渲染 B 时 , B 会进行深度测试 . 结果就是 B 会直接覆盖 A 的颜色 . 从视觉上来看 , B 就出现在了 A 的前面 , 而这是错误的 .

从这个例子可以看出 , 当关闭了深度写入后 , 渲染顺序是多么重要 . **我们应该在不透明物体渲染完之后再渲染半透明物体** . 那么 , 如果都是半透明物体 , 渲染顺序还重要吗 ? 答案是肯定的 . **半透明物体之间也要符合一定的渲染顺序** .

基于这两点 , 渲染引擎一般都会先对物体进行排序 , 再渲染 . 常用的方法是 :

1. 先渲染所有不透明物体 , 并开启它们的深度测试和深度写入 .
2. 把半透明物体按它们距离摄像机的远近进行排序 , 然后按照从后往前的顺序渲染这些半透明物体 , 并开启它们的深度测试 , 但关闭深度写入 .
